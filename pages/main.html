<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mardify - Dashboard</title>
    <link rel="stylesheet" href="../styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { min-height: 100vh; background: #0a0a0f; font-family: 'Poppins', sans-serif; overflow-x: hidden; }
        .titlebar { position: fixed; top: 0; left: 0; right: 0; height: 32px; background: rgba(10, 10, 15, 0.95); border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; align-items: center; justify-content: space-between; padding: 0 12px; z-index: 1000; -webkit-app-region: drag; }
        .titlebar-title span { font-size: 14px; font-weight: 600; color: white; }
        .titlebar-controls { display: flex; gap: 6px; -webkit-app-region: no-drag; }
        .window-btn { width: 28px; height: 28px; border: none; background: transparent; color: rgba(255, 255, 255, 0.7); cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .window-btn:hover { background: rgba(255, 255, 255, 0.1); }
        .window-btn.close:hover { background: #ef4444; }
        .page { min-height: 100vh; padding: 52px 20px 20px; position: relative; z-index: 10; display: flex; flex-direction: column; justify-content: flex-start; align-items: stretch; }
        .dashboard { max-width: 1200px; padding: 0 20px; width: 100%; display: flex; flex-direction: column; align-items: stretch; gap: 0; }
        .search-sticky-bar { position: sticky; top: 32px; z-index: 50; background: #0a0a0f; padding-bottom: 16px; margin-bottom: 4px; flex-shrink: 0; }
        .top-bar { display: flex; align-items: flex-start; gap: 16px; flex-wrap: wrap; justify-content: space-between; }
        .search-container { flex: 1; min-width: 200px; max-width: 500px; margin-top: 10px; align-self: flex-start; }
        .dashboard-header { display: flex; align-items: center; gap: 12px; flex-shrink: 0; margin-top: 10px; margin-left: auto; }
        .dashboard-title { font-size: 18px; font-weight: 600; color: white; white-space: nowrap; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; cursor: pointer; }
        .search-input { width: 100%; max-width: 600px; padding: 16px 20px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.05); color: white; font-size: 16px; font-family: 'Poppins', sans-serif; }
        .search-input:focus { outline: none; border-color: #667eea; }
        .btn { padding: 12px 20px; border-radius: 10px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-secondary { background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2); }
        .search-results { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .user-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 20px; }
        .user-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .user-card-avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .user-card-info h3 { color: white; font-size: 16px; margin-bottom: 4px; }
        .user-card-info p { color: rgba(255, 255, 255, 0.6); font-size: 12px; }
        .data-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; margin-bottom: 8px; }
        .data-label { color: rgba(255, 255, 255, 0.6); font-size: 12px; }
        .data-value { color: white; font-size: 13px; font-weight: 500; font-family: monospace; }
        .password-encrypted { color: #f59e0b; }
        .password-plain { color: #22c55e; }
        
        /* Estilos para la Galer√≠a de Servidores */
        .gallery-container { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 40px 0; flex-shrink: 0; }
        .nav-btn { position: fixed; top: 50%; transform: translateY(-50%); z-index: 100; width: 60px; height: 60px; border-radius: 50%; border: 2px solid #00ff88; background: rgba(0, 0, 0, 0.5); color: #00ff88; font-size: 24px; font-weight: bold; cursor: pointer; backdrop-filter: blur(5px); transition: all 0.3s ease; }
        .nav-btn:hover { background: rgba(0, 255, 136, 0.2); box-shadow: 0 0 20px #00ff88; }
        .nav-btn:disabled { opacity: 0.5; cursor: not-allowed; border-color: rgba(255, 255, 255, 0.3); color: rgba(255, 255, 255, 0.3); }
        #prevBtn { left: 20px; }
        #nextBtn { right: 20px; }
        .server-mega-card { position: relative; width: 800px; height: 400px; background: rgba(10, 10, 15, 0.9); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; box-shadow: 0 0 30px rgba(0, 255, 136, 0.3); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; overflow: hidden; }
        .server-mega-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at center, rgba(0, 255, 136, 0.1) 0%, transparent 70%); pointer-events: none; }
        .server-banner-container { width: 100%; margin-bottom: 20px; }
        .server-banner { width: 100%; border-radius: 8px; border: 1px solid #333; min-height: 100px; object-fit: contain; background: linear-gradient(90deg, #333 25%, #444 50%, #333 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .server-name { font-size: 48px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 4px; margin-bottom: 20px; text-shadow: 0 0 20px rgba(0, 255, 136, 0.5); }
        .server-ip { font-family: 'Courier New', monospace; font-size: 28px; color: #00ff88; background: rgba(0, 0, 0, 0.3); padding: 15px 30px; border-radius: 10px; border: 1px solid #00ff88; box-shadow: 0 0 15px rgba(0, 255, 136, 0.3); margin-bottom: 30px; }
        .server-password { font-size: 24px; font-weight: 700; padding: 15px 30px; border-radius: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); }
        .password-encrypted-mega { color: #f59e0b; border-color: #f59e0b; }
        .password-plain-mega { color: #22c55e; border-color: #22c55e; }
        .server-index { position: absolute; top: 20px; right: 30px; font-size: 14px; color: rgba(255, 255, 255, 0.5); }
        .fade-enter { opacity: 0; transform: scale(0.9); }
        .fade-enter-active { opacity: 1; transform: scale(1); transition: all 0.3s ease; }
        .fade-exit { opacity: 1; transform: scale(1); }
        .fade-exit-active { opacity: 0; transform: scale(0.9); transition: all 0.3s ease; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal.active { display: flex; }
        .modal-content { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 16px; padding: 24px; max-width: 500px; width: 90%; }
        .chat-input { width: 100%; padding: 12px 16px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.05); color: white; font-family: 'Poppins', sans-serif; box-sizing: border-box; }
        .empty-state { text-align: center; padding: 24px 20px; color: rgba(255, 255, 255, 0.6); }
        #searchResults { margin-top: 0; }
        .empty-state .empty-title { font-size: 48px; margin-bottom: 8px; }
        .empty-state .empty-sub { font-size: 14px; }
        .chat-sidebar { position: fixed; top: 36px; right: -400px; width: 380px; height: calc(100vh - 36px); background: rgba(10, 10, 15, 0.98); border-left: 1px solid rgba(255, 255, 255, 0.1); z-index: 100; transition: right 0.3s ease; display: flex; flex-direction: column; }
        .chat-sidebar.active { right: 0; }
        .chat-sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: space-between; align-items: center; }
        .chat-sidebar-header h2 { color: white; font-size: 18px; }
        .chat-sidebar-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .chat-message-bubble { display: flex; gap: 12px; align-items: flex-start; margin-bottom: 12px; }
        .chat-message-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; flex-shrink: 0; }
        .chat-message-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .chat-message-content { flex: 1; background: rgba(255, 255, 255, 0.05); padding: 12px 16px; border-radius: 16px; border-bottom-left-radius: 4px; }
        .chat-message-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .chat-message-name { color: #a78bfa; font-weight: 600; font-size: 14px; }
        .chat-message-time { color: rgba(255, 255, 255, 0.4); font-size: 11px; }
        .chat-message-text { color: rgba(255, 255, 255, 0.9); font-size: 14px; word-break: break-word; }
        .chat-sidebar-input { padding: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .chat-input-wrapper { display: flex; gap: 12px; }
        .chat-sidebar-toggle { position: fixed; right: 20px; bottom: 20px; width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: white; cursor: pointer; z-index: 99; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; }
        .chat-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 98; display: none; }
        .chat-overlay.active { display: block; }
        .modal-perfil-obligatorio .modal-content { border: 2px solid #f59e0b; }
        .loading-indicator { text-align: center; padding: 40px; display: none; }
        #alertContainer { margin-bottom: 16px; }
        
        /* Estilos para Videos de Transici√≥n */
        .video-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 99999;
            background: black;
            transition: opacity 0.5s ease-in-out;
            object-fit: cover;
            opacity: 0;
            pointer-events: none;
        }
        .video-overlay.fade-in { opacity: 1; transition: opacity 0.5s ease-in-out; }
        .video-overlay.fade-out { opacity: 0; transition: opacity 0.5s ease-in-out; }
    </style>
</head>
<body>
    <div class="titlebar">
        <div class="titlebar-title"><span>Mardify</span><span style="margin-left: 16px; font-size: 12px; color: rgba(255,255,255,0.5);">Dashboard</span></div>
        <div class="titlebar-controls">
            <button class="window-btn minimize" onclick="window.electronAPI.minimize()"><svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><rect x="1" y="5" width="10" height="2" rx="1"/></svg></button>
            <button class="window-btn maximize" onclick="window.electronAPI.maximize()"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.2"><rect x="1.5" y="1.5" width="9" height="9" rx="1"/></svg></button>
            <button class="window-btn close" onclick="closeWindow()"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.2"><path d="M1 1L11 11M11 1L1 11"/></svg></button>
        </div>
    </div>

    <div class="page">
        <div class="dashboard">
            <div class="search-sticky-bar">
                <div class="top-bar">
                    <div class="search-container">
                        <input type="text" id="searchInput" class="search-input" placeholder="Buscar servidores Minecraft..." autocomplete="off">
                    </div>
                    <header class="dashboard-header">
                        <h1 class="dashboard-title">Hola <span id="userDisplayName">Usuario</span>!</h1>
                        <div class="user-avatar" id="userAvatar" onclick="openProfileModal()">U</div>
                        <button class="btn btn-secondary" onclick="logout()">Salir</button>
                    </header>
                </div>
            </div>
            <div id="alertContainer"></div>
            
            <!-- Contenedor de Resultados -->
            <div id="searchResults"></div>
            
            <!-- Galer√≠a de Servidores -->
            <div class="gallery-container" style="display: none;">
                <button id="prevBtn" class="nav-btn">‚ùÆ</button>
                <div id="mainServerDisplay" class="server-mega-card">
                    <div class="server-banner-container">
                        <img id="mc-server-banner" class="server-banner" alt="Cargando estado del servidor...">
                    </div>
                    <div class="server-index">0 / 0</div>
                    <div class="server-name">Servidor</div>
                    <div class="server-ip">hycraft.us</div>
                    <div class="server-password password-plain-mega">Sin pass</div>
                </div>
                <button id="nextBtn" class="nav-btn">‚ùØ</button>
            </div>
        </div>

        <!-- Video Overlay para Transiciones -->
        <video id="loadingVideo" class="video-overlay" src="../cargando.mp4" playsinline></video>
        <video id="closingVideo" class="video-overlay" src="../cerrar.mp4" playsinline></video>

    <div class="chat-overlay" id="chatOverlay" onclick="toggleChatSidebar()"></div>
    <div class="chat-sidebar" id="chatSidebar">
        <div class="chat-sidebar-header"><h2>Chat Global</h2><button class="btn btn-secondary" onclick="toggleChatSidebar()" style="padding: 8px 12px;">X</button></div>
        <div class="chat-sidebar-messages" id="chatSidebarMessages"></div>
        <div class="chat-sidebar-input">
            <div class="chat-input-wrapper">
                <input type="text" id="chatSidebarInput" class="chat-input" placeholder="Escribe..." style="flex: 1;">
                <button class="btn btn-primary" onclick="enviarMensajeChat()">Enviar</button>
            </div>
        </div>
    </div>

    <button class="chat-sidebar-toggle" id="chatToggleBtn" onclick="toggleChatSidebar()">Chat</button>


    <script src="../renderer.js"></script>
    <script>
        var currentUser = null;
        var searchTimeout = null;
        var chatRefreshInterval = null;
        var selectedPhotoFile = null;
        var requiredPhotoFile = null;
        var isChatOpen = false;

        function closeWindow() { 
            if (currentUser && window.appAPI) {
                window.appAPI.saveSession(currentUser);
            }
            saveAppState();
            setTimeout(function() { showClosingVideo(); }, 100);
        }

        function saveAppState() {
            try {
                var galleryEl = document.querySelector('.gallery-container');
                var galleryVisible = galleryEl && galleryEl.style.display !== 'none';
                var state = {
                    lastSearch: document.getElementById('searchInput') ? document.getElementById('searchInput').value.trim() : '',
                    currentResults: window.currentResults || [],
                    currentIndex: window.currentIndex || 0,
                    galleryVisible: galleryVisible
                };
                if (window.appAPI && window.appAPI.saveAppState) {
                    window.appAPI.saveAppState(JSON.stringify(state));
                } else if (window.storageAPI) {
                    window.storageAPI.set('mardify_app_state', JSON.stringify(state));
                }
            } catch (e) { console.warn('Error guardando estado:', e); }
        }

        function restoreAppState() {
            try {
                var saved = null;
                if (window.appAPI && window.appAPI.getAppState) {
                    saved = window.appAPI.getAppState();
                } else if (window.storageAPI) {
                    saved = window.storageAPI.get('mardify_app_state');
                }
                if (!saved) { showEmptyState(); return; }
                if (!saved) { showEmptyState(); return; }
                var state = JSON.parse(saved);
                var searchInput = document.getElementById('searchInput');
                if (searchInput && state.lastSearch) searchInput.value = state.lastSearch;
                if (state.currentResults && state.currentResults.length > 0 && state.galleryVisible) {
                    window.currentResults = state.currentResults;
                    window.currentIndex = state.currentIndex || 0;
                    renderUsers(state.currentResults);
                    setTimeout(function() { renderServerCard(window.currentIndex); }, 50);
                } else if (searchInput && state.lastSearch) {
                    performSearch(state.lastSearch);
                } else {
                    showEmptyState();
                }
            } catch (e) { console.warn('Error restaurando estado:', e); showEmptyState(); }
        }

        function showClosingVideo() {
            var video = document.getElementById('closingVideo');
            if (!video) {
                if (window.electronAPI) window.electronAPI.close();
                return;
            }
            
            video.currentTime = 0;
            video.style.display = 'block';
            video.style.position = 'fixed';
            video.style.top = '0';
            video.style.left = '0';
            video.style.width = '100%';
            video.style.height = '100%';
            video.style.zIndex = '100000';
            video.style.opacity = '1';
            video.style.objectFit = 'cover';
            video.style.pointerEvents = 'none';
            video.style.backgroundColor = '#000';
            
            video.play().then(function() {
                video.onended = function() {
                    if (window.electronAPI) window.electronAPI.close();
                };
            }).catch(function(e) {
                console.warn('Video autoplay failed:', e);
                setTimeout(function() {
                    if (window.electronAPI) window.electronAPI.close();
                }, 1000);
            });
        }

        async function cerrarApp() {
            const video = document.getElementById('closingVideo');
            if (!video) {
                if (window.electronAPI) window.electronAPI.close();
                return;
            }
            video.style.display = 'block';
            video.classList.add('fade-in');
            try {
                await video.play();
                video.onended = () => {
                    if (window.electronAPI) window.electronAPI.close();
                };
            } catch (e) {
                console.warn('Video autoplay failed:', e);
                setTimeout(function() {
                    if (window.electronAPI) window.electronAPI.close();
                }, 1000);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            var session = window.appAPI.getSession();
            if (!session) { window.location.href = 'index.html'; return; }
            currentUser = session;
            updateUserUI();
            setupEventListeners();
            
            // Auto-Check al Iniciar: Verificar si necesita setup
            if (!currentUser.display_name) {
                console.log('User Status:', currentUser);
                openRequiredProfileModal();
            }
            
            checkUserProfileStatus();
            restoreAppState();
            window.addEventListener('beforeunload', saveAppState);
        });

        function setupEventListeners() {
            var searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') { e.preventDefault(); clearTimeout(searchTimeout); performSearch(searchInput.value); } });
                searchInput.addEventListener('input', function(e) { clearTimeout(searchTimeout); var query = e.target.value.trim(); if (query === '') { showEmptyState(); return; } searchTimeout = setTimeout(function() { performSearch(query); }, 500); });
            }

            var profilePhoto = document.getElementById('profilePhoto');
            if (profilePhoto) {
                profilePhoto.addEventListener('change', function(e) { var file = e.target.files[0]; if (file) { selectedPhotoFile = file; var reader = new FileReader(); reader.onload = function(e) { var preview = document.getElementById('photoPreview'); if (preview) preview.innerHTML = '<img src="' + e.target.result + '" style="width:100%;height:100%;object-fit:cover;">'; }; reader.readAsDataURL(file); } });
            }

            var requiredProfilePhoto = document.getElementById('requiredProfilePhoto');
            if (requiredProfilePhoto) {
                requiredProfilePhoto.addEventListener('change', function(e) { var file = e.target.files[0]; if (file) { requiredPhotoFile = file; var reader = new FileReader(); reader.onload = function(e) { var preview = document.getElementById('requiredPhotoPreview'); if (preview) preview.innerHTML = '<img src="' + e.target.result + '" style="width:100%;height:100%;object-fit:cover;">'; }; reader.readAsDataURL(file); } });
            }

            var profileForm = document.getElementById('profileForm');
            if (profileForm) profileForm.addEventListener('submit', function(e) { e.preventDefault(); saveProfile(); });

            var requiredForm = document.getElementById('profileRequiredForm');
            if (requiredForm) requiredForm.addEventListener('submit', function(e) { e.preventDefault(); saveRequiredProfile(); });

            var chatInput = document.getElementById('chatSidebarInput');
            if (chatInput) chatInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') { enviarMensajeChat(); } });
        }

        function checkUserProfileStatus() { 
            if (currentUser && currentUser.is_active === false) { 
                openRequiredProfileModal(); 
            } else if (currentUser && !currentUser.display_name) {
                // Si no tiene display_name, tambi√©n pedimos el setup
                openRequiredProfileModal();
            }
        }

        function updateUserUI() {
            var displayName = document.getElementById('userDisplayName');
            var userAvatar = document.getElementById('userAvatar');
            if (!currentUser) return;
            var email = currentUser.email || '';
            var name = currentUser.display_name || currentUser.fullname || currentUser.name || (email ? email.split('@')[0] : 'Usuario');
            if (displayName) displayName.textContent = name.split(' ')[0];
            if (userAvatar) { userAvatar.textContent = name.charAt(0).toUpperCase(); if (currentUser.photo_url) { var avatarUrl = currentUser.photo_url; if (!avatarUrl.startsWith('http')) { avatarUrl = 'https://basededatos.gokucomdohd.pro' + avatarUrl; } userAvatar.style.background = 'url(' + avatarUrl + ') center/cover'; userAvatar.textContent = ''; } }
            
            // Debug: Mostrar informaci√≥n del usuario en consola
            console.log('üë§ CurrentUser:', {
                id: currentUser.id,
                _id: currentUser._id,
                userId: currentUser.userId,
                display_name: currentUser.display_name,
                name: currentUser.name,
                fullname: currentUser.fullname,
                email: currentUser.email,
                photo_url: currentUser.photo_url
            });
        }

        function showEmptyState() { var container = document.getElementById('searchResults'); if (container) container.innerHTML = '<div class="empty-state"><div class="empty-title">Busca</div><div class="empty-sub">Ingresa un servidor arriba</div></div>'; }

        async function performSearch(query) {
            if (!query || query.trim() === '') { showEmptyState(); return; }
            
            showLoadingVideo();
            var minLoadTime = 2000;
            var startTime = Date.now();
            
            try {
                var token = window.appAPI.getToken();
                var url = 'https://basededatos.gokucomdohd.pro/search/api/user/' + encodeURIComponent(query);
                var response = await fetch(url, { method: 'GET', headers: { 'Authorization': token ? 'Bearer ' + token : '', 'Accept': 'application/json' } });
                if (!response.ok) throw new Error('Error ' + response.status);
                var data = await response.json();
                var users = Array.isArray(data) ? data : (data.users || data.data || data.results || []);
                
                var elapsed = Date.now() - startTime;
                var remaining = Math.max(0, minLoadTime - elapsed);
                setTimeout(function() {
                    hideLoadingVideo(function() {
                        renderUsers(users);
                        saveAppState();
                    });
                }, remaining);
            } catch (error) { 
                var elapsed = Date.now() - startTime;
                var remaining = Math.max(0, minLoadTime - elapsed);
                setTimeout(function() {
                    hideLoadingVideo(function() {
                        var container = document.getElementById('searchResults');
                        if (container) container.innerHTML = '<div class="empty-state"><div>Error</div><p style="color:#ef4444;">' + escapeHtml(error.message) + '</p></div>';
                    });
                }, remaining);
            }
        }

        function showLoadingVideo() {
            var video = document.getElementById('loadingVideo');
            if (!video) return;
            
            video.currentTime = 0;
            video.classList.remove('fade-out');
            video.classList.add('fade-in');
            video.style.display = 'block';
            video.style.pointerEvents = 'none';
            video.play().catch(function(e) {
                console.warn('Video autoplay failed:', e);
            });
        }

        function hideLoadingVideo(callback) {
            var video = document.getElementById('loadingVideo');
            if (!video) {
                if (callback) callback();
                return;
            }
            
            video.classList.remove('fade-in');
            video.classList.add('fade-out');
            
            setTimeout(function() {
                video.pause();
                video.currentTime = 0;
                video.classList.remove('fade-out');
                video.style.display = 'none';
                if (callback) callback();
            }, 500);
        }

        function renderUsers(users) {
            var container = document.getElementById('searchResults');
            var galleryContainer = document.querySelector('.gallery-container');
            var mainServerDisplay = document.getElementById('mainServerDisplay');
            
            if (!container || !galleryContainer || !mainServerDisplay) return;
            
            if (!users || users.length === 0) { 
                // Limpiar cualquier rastro anterior
                container.innerHTML = '';
                galleryContainer.style.display = 'none';
                return; 
            }
            
            // Limpiar cualquier rastro anterior
            container.innerHTML = '';
            
            // Guardar resultados y configurar galer√≠a
            window.currentResults = users;
            window.currentIndex = 0;
            
            // Mostrar galer√≠a
            galleryContainer.style.display = 'flex';
            
            // Renderizar la primera tarjeta
            renderServerCard(0);
        }

        function renderServerCard(index) {
            var users = window.currentResults || [];
            var mainServerDisplay = document.getElementById('mainServerDisplay');
            var serverIndex = mainServerDisplay.querySelector('.server-index');
            var serverName = mainServerDisplay.querySelector('.server-name');
            var serverIP = mainServerDisplay.querySelector('.server-ip');
            var serverPassword = mainServerDisplay.querySelector('.server-password');
            var serverBanner = mainServerDisplay.querySelector('.server-banner');
            var prevBtn = document.getElementById('prevBtn');
            var nextBtn = document.getElementById('nextBtn');
            
            if (!users || users.length === 0 || !mainServerDisplay) return;
            
            // Asegurar √≠ndice v√°lido
            if (index < 0) index = users.length - 1;
            if (index >= users.length) index = 0;
            window.currentIndex = index;
            
            var user = users[index];
            var serverIPValue = user.serverip || user.server_ip || user.ip || 'hycraft.us';
            var serverNameValue = user.server || user.server_name || (serverIPValue === 'hycraft.us' ? 'HyCraft' : 'Server');
            var password = user.password || '';
            var isEncrypted = password.startsWith('$SHA$') || password.length > 16;
            
            // Actualizar banner del servidor
            updateServerBanner(serverIPValue);
            
            // Actualizar contenido con transici√≥n
            mainServerDisplay.classList.remove('fade-enter-active', 'fade-exit-active');
            mainServerDisplay.classList.add('fade-exit');
            
            setTimeout(function() {
                if (serverIndex) serverIndex.textContent = (index + 1) + ' / ' + users.length;
                if (serverName) serverName.textContent = serverNameValue;
                if (serverIP) serverIP.textContent = serverIPValue;
                if (serverPassword) {
                    serverPassword.textContent = isEncrypted ? 'Encriptada' : (password || 'Sin pass');
                    serverPassword.className = 'server-password ' + (isEncrypted ? 'password-encrypted-mega' : 'password-plain-mega');
                }
                
                mainServerDisplay.classList.remove('fade-exit');
                mainServerDisplay.classList.add('fade-enter-active');
            }, 150);
            
            // Actualizar estado de botones
            if (prevBtn) prevBtn.disabled = users.length <= 1;
            if (nextBtn) nextBtn.disabled = users.length <= 1;
        }

        function updateServerBanner(serverIP) {
            var serverBanner = document.getElementById('mc-server-banner');
            if (!serverBanner) return;
            
            // Mostrar estado de carga
            serverBanner.classList.add('server-banner');
            serverBanner.src = '';
            serverBanner.alt = 'Cargando estado del servidor...';
            
            // Generar URL con timestamp para evitar cach√©
            var timestamp = Date.now();
            var bannerURL = 'https://mcapi.us/server/image?ip=' + encodeURIComponent(serverIP) + '&theme=dark&time=' + timestamp;
            
            // Cargar imagen
            var img = new Image();
            img.onload = function() {
                serverBanner.src = bannerURL;
                serverBanner.alt = 'Estado del servidor: ' + serverIP;
                serverBanner.classList.remove('server-banner');
            };
            img.onerror = function() {
                serverBanner.src = '';
                serverBanner.alt = 'No disponible';
                serverBanner.classList.remove('server-banner');
                serverBanner.style.background = '#333';
                serverBanner.style.color = '#666';
                serverBanner.textContent = 'Banner no disponible';
            };
            img.src = bannerURL;
        }

        // Configurar eventos de navegaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            var prevBtn = document.getElementById('prevBtn');
            var nextBtn = document.getElementById('nextBtn');
            
            if (prevBtn) {
                prevBtn.addEventListener('click', function() {
                    if (window.currentResults && window.currentResults.length > 1) {
                        window.currentIndex = (window.currentIndex - 1 + window.currentResults.length) % window.currentResults.length;
                        renderServerCard(window.currentIndex);
                        saveAppState();
                    }
                });
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', function() {
                    if (window.currentResults && window.currentResults.length > 1) {
                        window.currentIndex = (window.currentIndex + 1) % window.currentResults.length;
                        renderServerCard(window.currentIndex);
                        saveAppState();
                    }
                });
            }
        });

        function escapeHtml(text) { if (!text) return ''; var div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

        function showAlert(message) { var alertContainer = document.getElementById('alertContainer'); if (alertContainer) { alertContainer.innerHTML = '<div style="background:rgba(34,197,94,0.2);color:#22c55e;padding:12px 16px;border-radius:8px;margin-bottom:16px;">' + message + '</div>'; setTimeout(function() { alertContainer.innerHTML = ''; }, 3000); } }

        function toggleChatSidebar() {
            var sidebar = document.getElementById('chatSidebar');
            var overlay = document.getElementById('chatOverlay');
            var toggleBtn = document.getElementById('chatToggleBtn');
            if (!sidebar || !overlay || !toggleBtn) return;
            isChatOpen = !isChatOpen;
            if (isChatOpen) { if (!canUserChat()) { isChatOpen = false; openRequiredProfileModal(); return; } sidebar.classList.add('active'); overlay.classList.add('active'); toggleBtn.classList.add('active'); loadChatHistory(); startChatRefresh(); }
            else { sidebar.classList.remove('active'); overlay.classList.remove('active'); toggleBtn.classList.remove('active'); stopChatRefresh(); }
        }

        function canUserChat() { if (!currentUser) return false; if (currentUser.is_active === false) return false; if (!currentUser.display_name) return false; return true; }

        async function loadChatHistory() {
            try { var messages = await API.loadChatHistory(); renderChatMessages(messages); }
            catch (error) { console.error('Error:', error); var container = document.getElementById('chatSidebarMessages'); if (container) container.innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.5);">Sin mensajes</div>'; }
        }

        function renderChatMessages(messages) {
            const container = document.getElementById('chatSidebarMessages');
            if (!container) return;

            container.innerHTML = messages.map(msg => {
                // Log para ver qu√© llega exactamente (puedes borrarlo despu√©s)
                console.log("Mensaje recibido:", msg); 

                // EL FIX: Usamos msg.texto porque as√≠ se llama en tu base de datos
                // Si msg.texto no existe, ponemos un aviso para saber que fall√≥
                const contenido = msg.texto || msg.message || "Error: Mensaje vac√≠o";
                const nombre = msg.display_name || "An√≥nimo";
                const avatar = msg.avatar_url 
                    ? `https://basededatos.gokucomdohd.pro${msg.avatar_url}` 
                    : "assets/default-avatar.png";

                return `
                    <div class="chat-message" style="display: flex; gap: 10px; margin-bottom: 10px; padding: 5px; border-bottom: 1px solid #333;">
                        <img src="${avatar}" class="chat-message-avatar" style="width: 40px; height: 40px; border-radius: 50%;">
                        <div class="chat-message-content">
                            <div class="chat-message-header">
                                <strong style="color: #00ff88;">${nombre}</strong>
                                <small style="color: #666; margin-left: 10px;">${new Date(msg.created_at).toLocaleTimeString()}</small>
                            </div>
                            <div class="chat-message-text" style="color: white !important;">
                                ${contenido}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Auto-scroll al final
            container.scrollTop = container.scrollHeight;
        }

        function startChatRefresh() { chatRefreshInterval = setInterval(function() { loadChatHistory(); }, 5000); }
        function stopChatRefresh() { if (chatRefreshInterval) { clearInterval(chatRefreshInterval); chatRefreshInterval = null; } }

        async function enviarMensajeChat() {
            var input = document.getElementById('chatSidebarInput');
            var text = input ? input.value.trim() : '';
            if (!text) return;
            if (!canUserChat()) { if (input) input.value = ''; openRequiredProfileModal(); return; }
            
            // Intentar obtener userId de diferentes posibles campos
            var userId = currentUser && (currentUser.id || currentUser._id || currentUser.userId || currentUser.user_id || currentUser._id || currentUser.id_usuario);
            
            // Si no se encuentra userId, usar email como fallback (aunque no es ideal)
            if (!userId) {
                if (currentUser && currentUser.email) {
                    userId = currentUser.email;
                    console.log('‚ö†Ô∏è Usando email como userId fallback:', userId);
                } else {
                    showAlert('Error: No se encontr√≥ ID de usuario');
                    return;
                }
            }
            
            try { 
                await API.sendMessage(userId, text); 
                if (input) input.value = ''; 
                loadChatHistory(); 
            }
            catch (error) { 
                showAlert('Error al enviar: ' + error.message); 
            }
        }

        function openProfileModal() { document.getElementById('profileModal').classList.add('active'); var nameInput = document.getElementById('profileName'); if (nameInput) nameInput.value = currentUser && currentUser.display_name ? currentUser.display_name : ''; }
        function closeProfileModal() { document.getElementById('profileModal').classList.remove('active'); selectedPhotoFile = null; var preview = document.getElementById('photoPreview'); if (preview) preview.innerHTML = 'Foto'; }
        function openRequiredProfileModal() { document.getElementById('profileRequiredModal').classList.add('active'); var nameInput = document.getElementById('requiredProfileName'); if (nameInput) nameInput.value = currentUser && currentUser.display_name ? currentUser.display_name : ''; }
        function closeRequiredProfileModal() { document.getElementById('profileRequiredModal').classList.remove('active'); requiredPhotoFile = null; var preview = document.getElementById('requiredPhotoPreview'); if (preview) preview.innerHTML = 'Foto'; }

        async function saveProfile() {
            var name = document.getElementById('profileName').value.trim();
            var errorDiv = document.getElementById('profileError');
            if (!name) { if (errorDiv) { errorDiv.textContent = 'El nombre es obligatorio'; errorDiv.style.display = 'block'; } return; }
            if (errorDiv) errorDiv.style.display = 'none';
            try {
                // Intentar obtener userId de diferentes posibles campos
                var userId = currentUser && (currentUser.id || currentUser._id || currentUser.userId || currentUser.user_id || currentUser._id || currentUser.id_usuario);
                
                // Si no se encuentra userId, usar email como fallback (aunque no es ideal)
                if (!userId) {
                    if (currentUser && currentUser.email) {
                        userId = currentUser.email;
                        console.log('‚ö†Ô∏è Usando email como userId fallback:', userId);
                    } else {
                        throw new Error('No se encontr√≥ ID de usuario ni email');
                    }
                }
                
                console.log('üì§ Enviando setupProfile con userId:', userId);
                
                var response = await API.setupProfile(userId, name, selectedPhotoFile);
                if (response.status === 'SUCCESS' || response.success) {
                    currentUser = response.user || currentUser;
                    currentUser.display_name = name;
                    window.appAPI.saveSession(currentUser);
                    updateUserUI();
                    closeProfileModal();
                    showAlert('Perfil actualizado correctamente');
                } else { throw new Error(response.error || 'Error al guardar'); }
            } catch (error) { if (errorDiv) { errorDiv.textContent = 'Error: ' + error.message; errorDiv.style.display = 'block'; } }
        }

        async function saveRequiredProfile() {
            var name = document.getElementById('requiredProfileName').value.trim();
            var errorDiv = document.getElementById('requiredProfileError');
            if (!name) { if (errorDiv) { errorDiv.textContent = 'El nombre es obligatorio'; errorDiv.style.display = 'block'; } return; }
            if (errorDiv) errorDiv.style.display = 'none';
            try {
                // Intentar obtener userId de diferentes posibles campos
                var userId = currentUser && (currentUser.id || currentUser._id || currentUser.userId || currentUser.user_id || currentUser._id || currentUser.id_usuario);
                
                // Si no se encuentra userId, usar email como fallback (aunque no es ideal)
                if (!userId) {
                    if (currentUser && currentUser.email) {
                        userId = currentUser.email;
                        console.log('‚ö†Ô∏è Usando email como userId fallback:', userId);
                    } else {
                        throw new Error('No se encontr√≥ ID de usuario ni email');
                    }
                }
                
                console.log('üì§ Enviando setupProfile con userId:', userId);
                
                var response = await API.setupProfile(userId, name, requiredPhotoFile);
                console.log('Respuesta del setupProfile:', response);
                
                if (response.status === 'SUCCESS' || response.success) {
                    // Asegurarse de que el objeto de usuario est√© completo
                    var updatedUser = response.user || response;
                    
                    // Actualizar sesi√≥n local inmediatamente
                    currentUser = {
                        ...currentUser,
                        ...updatedUser,
                        display_name: name,
                        is_active: true
                    };
                    
                    window.appAPI.saveSession(currentUser);
                    console.log('‚úÖ Sesi√≥n guardada:', currentUser);
                    
                    updateUserUI();
                    closeRequiredProfileModal();
                    showAlert('Perfil configurado. Ya puedes chatear!');
                    if (isChatOpen) loadChatHistory();
                } else { 
                    throw new Error(response.error || response.message || 'Error al guardar'); 
                }
            } catch (error) { 
                console.error('‚ùå Error en saveRequiredProfile:', error);
                if (errorDiv) { 
                    errorDiv.textContent = 'Error: ' + error.message; 
                    errorDiv.style.display = 'block'; 
                } 
            }
        }

        function logout() { API.logout(); window.location.href = 'index.html'; }

        function openServerPopup(index, user) {
            var popup = document.getElementById('serverPopup');
            var content = document.getElementById('serverPopupContent');
            
            if (!popup || !content) return;
            
            // Generar HTML con todos los datos del JSON uno debajo del otro
            var htmlContent = '';
            
            // Iterar sobre todas las propiedades del objeto user
            for (var key in user) {
                if (user.hasOwnProperty(key)) {
                    var value = user[key];
                    if (value !== null && value !== undefined && value !== '') {
                        htmlContent += `
                            <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">${escapeHtml(key)}</div>
                                <div style="font-size: 16px; font-weight: 600; color: white; word-break: break-word;">${escapeHtml(value.toString())}</div>
                            </div>
                        `;
                    }
                }
            }
            
            // Si no hay datos, mostrar mensaje
            if (htmlContent === '') {
                htmlContent = '<div style="color: rgba(255,255,255,0.6); text-align: center; padding: 20px;">No hay datos disponibles</div>';
            }
            
            // A√±adir botones al final
            htmlContent += `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px;">
                    <button class="btn btn-primary" onclick="copyToClipboard('${escapeHtml(user.serverip || user.server_ip || user.ip || 'hycraft.us')}')" style="width: 100%;">Copiar IP</button>
                    <button class="btn btn-secondary" onclick="closeServerPopup()" style="width: 100%;">Cerrar</button>
                </div>
            `;
            
            content.innerHTML = htmlContent;
            popup.classList.add('active');
        }

        function closeServerPopup() {
            var popup = document.getElementById('serverPopup');
            if (popup) popup.classList.remove('active');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                showAlert('IP copiada al portapapeles');
            }).catch(function(err) {
                console.error('Error al copiar:', err);
                showAlert('Error al copiar la IP');
            });
        }

        console.log('Dashboard cargado');
    </script>
</body>
</html>
